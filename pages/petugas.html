    <!DOCTYPE html>
    <html lang="id">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Dashboard Petugas - TEBARDARLING</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
         integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
         crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
         integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
         crossorigin=""></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <style>
            body {
                font-family: 'Inter', sans-serif;
                background-color: #f0f9ff; /* sky-50 */
            }
            .leaflet-container {
                height: 300px;
                width: 100%;
                border-radius: 0.5rem; /* rounded-lg */
            }
            .modal {
                display: none; /* Hidden by default */
                position: fixed; /* Stay in place */
                z-index: 1000; /* Sit on top */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgb(0,0,0); /* Fallback color */
                background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
                padding-top: 60px;
            }
            .modal-content {
                background-color: #fefefe;
                margin: 5% auto;
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
                max-width: 500px;
                border-radius: 0.5rem;
                text-align: center;
            }
            .modal-buttons button {
                margin: 0 10px;
            }
            #timer {
                font-size: 1.5em;
                font-weight: bold;
            }
        </style>
    </head>
    <body class="p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
            <header class="mb-8 text-center">
                <h1 class="text-3xl font-bold text-sky-700">Dashboard Petugas TEBARDARLING</h1>
                <p class="text-sky-600">Selamat Datang, <span id="officerName">[Nama Petugas]</span> (ID: <span id="officerId">[ID Petugas]</span>)</p>
                <p class="text-sm text-gray-500">User ID (untuk admin): <span id="displayUserId" class="font-mono"></span></p>
            </header>

            <!-- Status GPS -->
            <div id="gpsStatus" class="mb-4 p-3 rounded-lg text-center text-white bg-orange-500">
                <i class="fas fa-map-marker-alt"></i> Menginisialisasi GPS... Pastikan GPS Anda aktif dan berikan izin lokasi.
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Kolom Kiri: Absensi & Peta -->
                <div class="space-y-6">
                    <!-- Kartu Absensi -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-sky-700 mb-4"><i class="fas fa-user-clock"></i> Absensi Kehadiran</h2>
                        <div class="space-y-3">
                            <button id="clockInButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out flex items-center justify-center space-x-2">
                                <i class="fas fa-sign-in-alt"></i>
                                <span>Absen Masuk</span>
                            </button>
                            <button id="clockOutButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out flex items-center justify-center space-x-2" disabled>
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Absen Keluar</span>
                            </button>
                        </div>
                        <div class="mt-4 text-center">
                            <p class="text-sm text-gray-600">Status: <span id="attendanceStatus" class="font-semibold text-gray-800">Belum Absen</span></p>
                            <p class="text-sm text-gray-600">Waktu Kerja: <span id="timer" class="text-sky-600">00:00:00</span></p>
                            <p id="clockInTimeDisplay" class="text-xs text-gray-500 mt-1"></p>
                        </div>
                    </div>

                    <!-- Kartu Peta -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-sky-700 mb-4"><i class="fas fa-map-marked-alt"></i> Lokasi Anda Saat Ini</h2>
                        <div id="map"></div>
                        <p class="text-xs text-gray-500 mt-2 text-center">Koordinat: <span id="coordinatesDisplay">-</span></p>
                    </div>
                </div>

                <!-- Kolom Kanan: Dokumentasi -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-sky-700 mb-4"><i class="fas fa-camera"></i> Unggah Dokumentasi Kerja</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="workPhoto" class="block text-sm font-medium text-gray-700 mb-1">Pilih Foto:</label>
                            <input type="file" id="workPhoto" name="workPhoto" accept="image/*" class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-lg file:border-0
                                file:text-sm file:font-semibold
                                file:bg-sky-50 file:text-sky-700
                                hover:file:bg-sky-100" disabled>
                        </div>
                        <div id="photoPreviewContainer" class="mt-2 hidden">
                            <img id="photoPreview" src="#" alt="Pratinjau Foto" class="max-h-60 w-auto mx-auto rounded-lg shadow"/>
                        </div>
                        <textarea id="photoDescription" placeholder="Deskripsi singkat pekerjaan..." rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500" disabled></textarea>
                        <button id="uploadPhotoButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out flex items-center justify-center space-x-2" disabled>
                            <i class="fas fa-upload"></i>
                            <span>Unggah Foto & Deskripsi</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Notifikasi -->
        <div id="notificationModal" class="modal">
            <div class="modal-content">
                <p id="modalMessage" class="mb-4 text-lg"></p>
                <div id="modalButtons" class="modal-buttons">
                    <button id="modalOkButton" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">OK</button>
                    <button id="modalConfirmButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg hidden">Konfirmasi</button>
                    <button id="modalCancelButton" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded-lg hidden">Batal</button>
                </div>
            </div>
        </div>

        <script type="module">
            // Import Supabase SDK
            import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

            console.log("Supabase SDK: typeof createClient after import:", typeof createClient);

            const SUPABASE_URL = 'https://zunrijrufbpldgfztroz.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1bnJpanJ1ZmJwbGRnZnp0cm96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMjY4MzcsImV4cCI6MjA2NDYwMjgzN30.bUDiCIx-gM_nBUZWoU8N2311MlwQq7SOt1-fkyyWdbU';

            let supabaseClient; 

            // DOM Elements
            const officerNameEl = document.getElementById('officerName');
            const officerIdEl = document.getElementById('officerId');
            const displayUserIdEl = document.getElementById('displayUserId');
            const clockInButton = document.getElementById('clockInButton');
            const clockOutButton = document.getElementById('clockOutButton');
            const attendanceStatusEl = document.getElementById('attendanceStatus');
            const timerEl = document.getElementById('timer');
            const clockInTimeDisplayEl = document.getElementById('clockInTimeDisplay');
            const mapEl = document.getElementById('map');
            const coordinatesDisplayEl = document.getElementById('coordinatesDisplay');
            const workPhotoInput = document.getElementById('workPhoto');
            const photoPreview = document.getElementById('photoPreview');
            const photoPreviewContainer = document.getElementById('photoPreviewContainer');
            const photoDescriptionInput = document.getElementById('photoDescription');
            const uploadPhotoButton = document.getElementById('uploadPhotoButton');
            const gpsStatusEl = document.getElementById('gpsStatus');
            const notificationModal = document.getElementById('notificationModal');
            const modalMessageEl = document.getElementById('modalMessage');
            const modalOkButton = document.getElementById('modalOkButton');
            const modalConfirmButton = document.getElementById('modalConfirmButton');
            const modalCancelButton = document.getElementById('modalCancelButton');

            // App State
            let currentOfficer = null;
            let officerUserId = null;
            let map = null;
            let marker = null;
            let currentPosition = null;
            let isClockedIn = false;
            let clockInTime = null;
            let workTimerInterval = null;
            let locationWatchId = null;
            const MIN_WORK_HOURS = 8;
            let activeAttendanceId = null;

            async function mainAppLogic() {
                async function handleUserSession() {
                    if (!supabaseClient) {
                        console.error("Supabase client is not initialized yet in handleUserSession.");
                        showNotification("Kesalahan internal: Klien Supabase belum siap.", true);
                        disableAppFeatures();
                        return;
                    }
                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    if (sessionError) {
                        console.error("Error getting session:", sessionError);
                        showNotification("Gagal mengambil sesi. Coba muat ulang halaman.", true);
                        disableAppFeatures();
                        return;
                    }

                    if (session && session.user) {
                        currentOfficer = session.user;
                        officerUserId = currentOfficer.id;
                        officerNameEl.textContent = currentOfficer.user_metadata?.full_name || currentOfficer.email || "Petugas";
                        officerIdEl.textContent = currentOfficer.id.substring(0, 8);
                        displayUserIdEl.textContent = officerUserId;
                        console.log('User signed in:', currentOfficer);
                        await checkExistingAttendance();
                        initApp();
                    } else {
                        showNotification("Sesi tidak ditemukan. Silakan login terlebih dahulu.", true);
                        disableAppFeatures();
                        gpsStatusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Anda harus login untuk menggunakan dashboard.';
                        gpsStatusEl.className = 'mb-4 p-3 rounded-lg text-center text-white bg-red-700';
                    }
                }

                if (!supabaseClient) {
                    console.error("mainAppLogic: Supabase client is NOT INITIALIZED before attempting to set onAuthStateChanged.");
                    return; 
                }
                
                console.log("mainAppLogic: Attempting to set onAuthStateChanged.");
                if (supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.onAuthStateChanged === 'function') {
                    console.log("mainAppLogic: supabaseClient.auth.onAuthStateChanged IS a function. Setting listener.");
                } else {
                    console.error("mainAppLogic: supabaseClient.auth.onAuthStateChanged IS NOT a function or auth is missing!");
                    console.log("mainAppLogic: typeof supabaseClient.auth:", typeof supabaseClient.auth);
                    if(supabaseClient) console.log("mainAppLogic: supabaseClient.auth value:", supabaseClient.auth);
                    if(supabaseClient && supabaseClient.auth) console.log("mainAppLogic: typeof supabaseClient.auth.onAuthStateChanged:", typeof supabaseClient.auth.onAuthStateChanged);
                    showNotification("Kesalahan: Fitur autentikasi tidak dapat dimuat dengan benar.", true);
                    disableAppFeatures();
                    return; 
                }

                supabaseClient.auth.onAuthStateChanged(async (event, session) => { 
                    console.log('Auth event:', event, session);
                    if (event === 'SIGNED_IN' && session?.user) {
                        currentOfficer = session.user;
                        officerUserId = currentOfficer.id;
                        officerNameEl.textContent = currentOfficer.user_metadata?.full_name || currentOfficer.email || "Petugas";
                        officerIdEl.textContent = currentOfficer.id.substring(0, 8);
                        displayUserIdEl.textContent = officerUserId;
                        console.log('User signed in via onAuthStateChanged:', currentOfficer);
                        await checkExistingAttendance();
                        initApp();
                    } else if (event === 'SIGNED_OUT') {
                        currentOfficer = null;
                        officerUserId = null;
                        activeAttendanceId = null;
                        showNotification("Anda telah keluar. Silakan masuk kembali untuk melanjutkan.");
                        disableAppFeatures();
                    }
                });
                await handleUserSession();
            }

            function initApp() {
                if (officerUserId) {
                    initMap();
                    startGpsTracking();
                    clockInButton.addEventListener('click', handleClockIn);
                    clockOutButton.addEventListener('click', handleClockOutAttempt);
                    workPhotoInput.addEventListener('change', handlePhotoPreview);
                    uploadPhotoButton.addEventListener('click', handleUploadPhoto);
                    modalOkButton.addEventListener('click', () => closeModal());
                    modalCancelButton.addEventListener('click', () => closeModal());
                    clockInButton.disabled = isClockedIn;
                    clockOutButton.disabled = !isClockedIn;
                    workPhotoInput.disabled = !isClockedIn;
                    photoDescriptionInput.disabled = !isClockedIn;
                    uploadPhotoButton.disabled = !isClockedIn;
                } else {
                    console.error("User not authenticated. App features remain disabled.");
                    gpsStatusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Autentikasi diperlukan untuk menggunakan fitur.';
                    gpsStatusEl.className = 'mb-4 p-3 rounded-lg text-center text-white bg-red-600';
                    disableAppFeatures();
                }
            }

            function disableAppFeatures() {
                clockInButton.disabled = true;
                clockOutButton.disabled = true;
                workPhotoInput.disabled = true;
                photoDescriptionInput.disabled = true;
                uploadPhotoButton.disabled = true;
                attendanceStatusEl.textContent = "Tidak Aktif";
                timerEl.textContent = "00:00:00";
                if (map && typeof map.remove === 'function') map.remove();
                map = null;
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                }
                if (workTimerInterval) {
                    clearInterval(workTimerInterval);
                    workTimerInterval = null;
                }
                isClockedIn = false;
                clockInTime = null;
                activeAttendanceId = null;
            }

            async function checkExistingAttendance() {
                if (!officerUserId || !supabaseClient) return;
                const { data, error } = await supabaseClient
                    .from('attendance')
                    .select('*')
                    .eq('officer_id', officerUserId)
                    .is('clock_out_time', null)
                    .order('clock_in_time', { ascending: false })
                    .limit(1);

                if (error) {
                    console.error('Error fetching existing attendance:', error);
                    showNotification('Gagal memeriksa status absensi sebelumnya.', true);
                    return;
                }

                if (data && data.length > 0) {
                    const lastAttendance = data[0];
                    activeAttendanceId = lastAttendance.id;
                    isClockedIn = true;
                    clockInTime = new Date(lastAttendance.clock_in_time);
                    currentPosition = {
                        latitude: lastAttendance.clock_in_latitude,
                        longitude: lastAttendance.clock_in_longitude,
                        accuracy: lastAttendance.clock_in_accuracy
                    };
                    updateUIForClockedIn();
                    startWorkTimer();
                    showNotification("Melanjutkan sesi absensi sebelumnya.", false, 2000);
                } else {
                    isClockedIn = false;
                    activeAttendanceId = null;
                    updateUIForClockedOut();
                }
            }

            function initMap() {
                if (map) {
                    map.remove();
                    map = null;
                }
                const defaultLocation = [3.5952, 98.6722]; // Medan
                map = L.map(mapEl).setView(defaultLocation, 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                marker = L.marker(defaultLocation).addTo(map);
                marker.bindPopup("Lokasi Anda").openPopup();
            }

            function startGpsTracking() {
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                }
                if (navigator.geolocation) {
                    locationWatchId = navigator.geolocation.watchPosition(
                        async (position) => {
                            currentPosition = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            gpsStatusEl.innerHTML = `<i class="fas fa-check-circle"></i> GPS Aktif. Akurasi: ${currentPosition.accuracy.toFixed(0)} meter.`;
                            gpsStatusEl.className = 'mb-4 p-3 rounded-lg text-center text-white bg-green-500';

                            const latLng = [currentPosition.latitude, currentPosition.longitude];
                            if (map) {
                               map.setView(latLng, 16);
                               marker.setLatLng(latLng).setPopupContent(`Lokasi Anda Saat Ini<br>Lat: ${currentPosition.latitude.toFixed(5)}, Lng: ${currentPosition.longitude.toFixed(5)}`).openPopup();
                            }
                            coordinatesDisplayEl.textContent = `${currentPosition.latitude.toFixed(5)}, ${currentPosition.longitude.toFixed(5)}`;

                            if (isClockedIn && officerUserId && supabaseClient) { 
                               try {
                                   const { error: locError } = await supabaseClient.from('officer_locations').upsert({
                                       officer_id: officerUserId,
                                       latitude: currentPosition.latitude,
                                       longitude: currentPosition.longitude,
                                       timestamp: new Date().toISOString()
                                   }, { onConflict: 'officer_id' });
                                   if (locError) console.error("Error updating officer location:", locError);
                               } catch (e) {
                                    console.error("Exception updating officer location:", e);
                               }
                            }
                        },
                        (error) => {
                            console.error("Error GPS:", error);
                            let errorMsg = "Gagal mendapatkan lokasi GPS.";
                            if (error.code === error.PERMISSION_DENIED) {
                                errorMsg = "Izin lokasi ditolak. Fitur peta dan absensi berbasis lokasi tidak akan berfungsi.";
                            } else if (error.code === error.POSITION_UNAVAILABLE) {
                                errorMsg = "Informasi lokasi tidak tersedia.";
                            } else if (error.code === error.TIMEOUT) {
                                errorMsg = "Waktu permintaan lokasi habis.";
                            }
                            gpsStatusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMsg}`;
                            gpsStatusEl.className = 'mb-4 p-3 rounded-lg text-center text-white bg-red-600';
                            coordinatesDisplayEl.textContent = 'Tidak tersedia / Error';
                            if (error.code === error.PERMISSION_DENIED) {
                                clockInButton.disabled = true;
                                clockInButton.title = "Izin lokasi diperlukan untuk absen.";
                            }
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    gpsStatusEl.textContent = "Browser Anda tidak mendukung Geolocation.";
                    gpsStatusEl.className = 'mb-4 p-3 rounded-lg text-center text-white bg-red-600';
                    disableAppFeatures();
                }
            }

            async function handleClockIn() {
                if (!officerUserId || !supabaseClient) { 
                    showNotification("Autentikasi gagal atau klien Supabase belum siap.", true);
                    return;
                }
                if (!currentPosition) {
                    showNotification("Lokasi GPS tidak ditemukan. Pastikan GPS aktif dan izin diberikan. Tidak bisa absen.", true);
                    return;
                }
                if (isClockedIn) {
                    showNotification("Anda sudah absen masuk.", false);
                    return;
                }

                clockInButton.disabled = true;
                clockInButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Proses...';

                clockInTime = new Date();
                const attendanceData = {
                    officer_id: officerUserId,
                    clock_in_time: clockInTime.toISOString(),
                    clock_in_latitude: currentPosition.latitude,
                    clock_in_longitude: currentPosition.longitude,
                    clock_in_accuracy: currentPosition.accuracy
                };

                const { data, error } = await supabaseClient
                    .from('attendance')
                    .insert([attendanceData])
                    .select();


                if (error || !data || data.length === 0) {
                    console.error("Error clocking in:", error);
                    showNotification("Gagal melakukan absensi masuk. Coba lagi.", true);
                    clockInButton.disabled = false;
                    clockInButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Absen Masuk';
                } else {
                    isClockedIn = true;
                    activeAttendanceId = data[0].id;
                    showNotification(`Berhasil absen masuk pada ${clockInTime.toLocaleTimeString()} di lokasi (${currentPosition.latitude.toFixed(4)}, ${currentPosition.longitude.toFixed(4)})`, false, 3000);
                    updateUIForClockedIn();
                    startWorkTimer();
                }
            }

            function updateUIForClockedIn() {
                attendanceStatusEl.textContent = "Sudah Absen Masuk";
                attendanceStatusEl.className = "font-semibold text-green-600";
                clockInButton.disabled = true;
                clockOutButton.disabled = false;
                workPhotoInput.disabled = false;
                photoDescriptionInput.disabled = false;
                uploadPhotoButton.disabled = false;
                if (clockInTime) {
                    clockInTimeDisplayEl.textContent = `Masuk: ${clockInTime.toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}`;
                }
            }

            function updateUIForClockedOut() {
                attendanceStatusEl.textContent = "Belum Absen / Sudah Keluar";
                attendanceStatusEl.className = "font-semibold text-gray-800";
                clockInButton.disabled = false;
                clockOutButton.disabled = true;
                workPhotoInput.disabled = true;
                photoDescriptionInput.disabled = true;
                uploadPhotoButton.disabled = true;
                timerEl.textContent = "00:00:00";
            }

            function handleClockOutAttempt() {
                if (!isClockedIn || !clockInTime) {
                    showNotification("Anda belum absen masuk atau sesi tidak valid.", true);
                    return;
                }
                const now = new Date();
                const timeDiffMs = now.getTime() - clockInTime.getTime();
                const hoursWorked = timeDiffMs / (1000 * 60 * 60);

                if (hoursWorked < MIN_WORK_HOURS) {
                    const remainingTimeMs = (MIN_WORK_HOURS * 60 * 60 * 1000) - timeDiffMs;
                    const remainingHours = Math.floor(remainingTimeMs / (1000 * 60 * 60));
                    const remainingMinutes = Math.floor((remainingTimeMs % (1000 * 60 * 60)) / (1000 * 60));
                    showModalConfirmation(
                        `Anda belum bisa absen keluar. Jam kerja minimal ${MIN_WORK_HOURS} jam. Waktu kerja Anda saat ini: ${formatDuration(timeDiffMs)}. Sisa waktu: sekitar ${remainingHours} jam ${remainingMinutes} menit.`,
                        null,
                        true
                    );
                } else {
                    showModalConfirmation(
                        `Konfirmasi absen keluar? Waktu kerja Anda: ${formatDuration(timeDiffMs)}.`,
                        handleClockOutConfirm
                    );
                }
            }

            async function handleClockOutConfirm() {
                if (!currentPosition) {
                    showNotification("Lokasi GPS tidak ditemukan untuk absen keluar. Coba lagi.", true);
                    closeModal();
                    return;
                }
                if (!activeAttendanceId || !supabaseClient) { 
                    showNotification("ID Absensi aktif tidak ditemukan atau klien Supabase belum siap.", true);
                    console.error("Error: activeAttendanceId is null or supabaseClient not ready during clock out.");
                    closeModal();
                    return;
                }

                closeModal();
                clockOutButton.disabled = true;
                clockOutButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Proses...';

                const clockOutTime = new Date();
                const timeDiffMs = clockOutTime.getTime() - clockInTime.getTime();

                const attendanceUpdateData = {
                    clock_out_time: clockOutTime.toISOString(),
                    clock_out_latitude: currentPosition.latitude,
                    clock_out_longitude: currentPosition.longitude,
                    clock_out_accuracy: currentPosition.accuracy,
                    work_duration_ms: timeDiffMs
                };

                const { data, error } = await supabaseClient
                    .from('attendance')
                    .update(attendanceUpdateData)
                    .eq('id', activeAttendanceId)
                    .eq('officer_id', officerUserId)
                    .select();

                if (error || !data || data.length === 0) {
                    console.error("Error clocking out:", error);
                    showNotification("Gagal melakukan absensi keluar. Coba lagi.", true);
                    clockOutButton.disabled = !isClockedIn;
                    clockOutButton.innerHTML = '<i class="fas fa-sign-out-alt"></i> Absen Keluar';
                } else {
                    isClockedIn = false;
                    activeAttendanceId = null;
                    stopWorkTimer();
                    showNotification(`Berhasil absen keluar pada ${clockOutTime.toLocaleTimeString()}. Total jam kerja: ${formatDuration(timeDiffMs)}.`, false, 4000);
                    updateUIForClockedOut();
                    clockInTimeDisplayEl.textContent = `Keluar: ${clockOutTime.toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}`;
                    photoPreviewContainer.classList.add('hidden');
                    workPhotoInput.value = '';
                    photoDescriptionInput.value = '';
                }
            }

            function startWorkTimer() {
                if (workTimerInterval) clearInterval(workTimerInterval);
                workTimerInterval = setInterval(() => {
                    if (isClockedIn && clockInTime) {
                        const now = new Date();
                        const timeDiffMs = now.getTime() - clockInTime.getTime();
                        timerEl.textContent = formatDuration(timeDiffMs);
                    }
                }, 1000);
            }

            function stopWorkTimer() {
                clearInterval(workTimerInterval);
                workTimerInterval = null;
            }

            function formatDuration(ms) {
                let seconds = Math.floor((ms / 1000) % 60);
                let minutes = Math.floor((ms / (1000 * 60)) % 60);
                let hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
                hours = (hours < 10) ? "0" + hours : hours;
                minutes = (minutes < 10) ? "0" + minutes : minutes;
                seconds = (seconds < 10) ? "0" + seconds : seconds;
                return hours + ":" + minutes + ":" + seconds;
            }

            function handlePhotoPreview(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        photoPreview.src = e.target.result;
                        photoPreviewContainer.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                } else {
                    photoPreviewContainer.classList.add('hidden');
                }
            }

            async function handleUploadPhoto() {
                if (!officerUserId || !supabaseClient) { 
                     showNotification("Autentikasi gagal atau klien Supabase belum siap.", true);
                    return;
                }
                if (!isClockedIn) {
                    showNotification("Anda harus absen masuk terlebih dahulu untuk mengunggah dokumentasi.", true);
                    return;
                }
                 if (!activeAttendanceId) {
                    showNotification("Sesi absensi aktif tidak ditemukan. Tidak bisa mengunggah foto.", true);
                    return;
                }
                const file = workPhotoInput.files[0];
                const description = photoDescriptionInput.value.trim();

                if (!file) {
                    showNotification("Pilih file foto terlebih dahulu.", true);
                    return;
                }
                if (!description) {
                    showNotification("Deskripsi foto tidak boleh kosong.", true);
                    return;
                }
                if (!currentPosition) {
                    showNotification("Lokasi GPS tidak ditemukan. Tidak bisa mengunggah foto saat ini.", true);
                    return;
                }

                uploadPhotoButton.disabled = true;
                uploadPhotoButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengunggah...';

                try {
                    const fileName = `${officerUserId}_${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
                    const filePath = `work_documentation/${fileName}`;

                    const { data: uploadData, error: uploadError } = await supabaseClient.storage
                        .from('work_photos')
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (uploadError) throw uploadError;

                    const photoDocumentationData = {
                        officer_id: officerUserId,
                        attendance_id: activeAttendanceId,
                        photo_path: uploadData.path,
                        description: description,
                        latitude: currentPosition.latitude,
                        longitude: currentPosition.longitude,
                        timestamp: new Date().toISOString(),
                    };

                    const { error: dbError } = await supabaseClient
                        .from('work_documentation')
                        .insert([photoDocumentationData]);

                    if (dbError) throw dbError;

                    showNotification("Foto dokumentasi berhasil diunggah!", false, 3000);
                    photoPreviewContainer.classList.add('hidden');
                    workPhotoInput.value = '';
                    photoDescriptionInput.value = '';

                } catch (error) {
                    console.error("Error uploading photo:", error);
                    showNotification(`Gagal mengunggah foto: ${error.message || 'Error tidak diketahui'}. Coba lagi.`, true);
                } finally {
                    uploadPhotoButton.disabled = !isClockedIn;
                    uploadPhotoButton.innerHTML = '<i class="fas fa-upload"></i> Unggah Foto & Deskripsi';
                }
            }

            function showNotification(message, isError = false, duration = null) {
                modalMessageEl.textContent = message;
                modalMessageEl.className = isError ? 'mb-4 text-lg text-red-600' : 'mb-4 text-lg text-green-600';
                modalOkButton.classList.remove('hidden');
                modalConfirmButton.classList.add('hidden');
                modalCancelButton.classList.add('hidden');
                notificationModal.style.display = "block";

                if (duration) {
                    setTimeout(() => {
                        if (notificationModal.style.display === "block" && modalMessageEl.textContent === message) {
                            closeModal();
                        }
                    }, duration);
                }
            }

            function showModalConfirmation(message, confirmAction, isInfoOnly = false) {
                modalMessageEl.textContent = message;
                modalMessageEl.className = 'mb-4 text-lg text-gray-700';

                if (isInfoOnly) {
                    modalOkButton.classList.remove('hidden');
                    modalConfirmButton.classList.add('hidden');
                    modalCancelButton.classList.add('hidden');
                     modalOkButton.onclick = () => closeModal();
                } else {
                    modalOkButton.classList.add('hidden');
                    modalConfirmButton.classList.remove('hidden');
                    modalCancelButton.classList.remove('hidden');

                    const oldConfirmButton = document.getElementById('modalConfirmButton');
                    const newConfirmButton = oldConfirmButton.cloneNode(true);
                    oldConfirmButton.parentNode.replaceChild(newConfirmButton, oldConfirmButton);
                    newConfirmButton.addEventListener('click', confirmAction);

                    const oldCancelButton = document.getElementById('modalCancelButton');
                    const newCancelButton = oldCancelButton.cloneNode(true);
                    oldCancelButton.parentNode.replaceChild(newCancelButton, oldCancelButton);
                    newCancelButton.addEventListener('click', () => closeModal());
                }
                notificationModal.style.display = "block";
            }

            function closeModal() {
                notificationModal.style.display = "none";
            }

            window.onclick = function(event) {
                if (event.target == notificationModal) {
                    if (!modalConfirmButton.classList.contains('hidden') || !modalCancelButton.classList.contains('hidden')) {
                        return;
                    }
                    closeModal();
                }
            }

            // --- Inisialisasi Klien Supabase dan Panggil Logika Utama ---
            // Pembungkus ini memastikan bahwa semua kode DOM dan Supabase dijalankan setelah DOM siap.
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    if (typeof createClient !== 'function') {
                        console.error("Supabase SDK: createClient is not a function! Check import.");
                        throw new Error("Supabase createClient function not available.");
                    }
                    supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    
                    console.log("Attempting to initialize. typeof supabaseClient:", typeof supabaseClient);
                    if (supabaseClient) {
                        console.log("supabaseClient object after createClient:", supabaseClient);
                        console.log("typeof supabaseClient.auth:", typeof supabaseClient.auth);
                        if (supabaseClient.auth) {
                           console.log("supabaseClient.auth object:", supabaseClient.auth);
                           console.log("typeof supabaseClient.auth.onAuthStateChanged:", typeof supabaseClient.auth.onAuthStateChanged);
                        } else {
                           console.error("supabaseClient.auth is undefined or null AFTER createClient.");
                        }
                    } else {
                        console.error("supabaseClient is undefined or null AFTER createClient call.");
                    }

                    // Panggil mainAppLogic setelah pengecekan awal
                    if (supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.onAuthStateChanged === 'function') {
                        console.log("INITIALIZATION: Supabase client seems OK. Calling mainAppLogic.");
                        mainAppLogic();
                    } else {
                        console.error("INITIALIZATION: Critical issue with Supabase client or auth module. Not calling mainAppLogic.");
                        // Tambahan: Coba panggil mainAppLogic dengan penundaan sebagai upaya terakhir untuk diagnostik
                        showNotification("Masalah inisialisasi awal, mencoba lagi...", true, 2000);
                        setTimeout(() => {
                            console.log("Attempting DELAYED call to mainAppLogic.");
                            if (supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.onAuthStateChanged === 'function') {
                                 console.log("DELAYED call: supabaseClient.auth.onAuthStateChanged IS NOW a function.");
                                 mainAppLogic();
                            } else {
                                 console.error("DELAYED call: supabaseClient.auth.onAuthStateChanged IS STILL NOT a function.");
                                 if(supabaseClient) console.log("DELAYED call: typeof supabaseClient.auth:", typeof supabaseClient.auth);
                                 if(supabaseClient && supabaseClient.auth) console.log("DELAYED call: typeof supabaseClient.auth.onAuthStateChanged:", typeof supabaseClient.auth.onAuthStateChanged);
                                 else if(supabaseClient) console.log("DELAYED call: supabaseClient.auth is still problematic.");
                                 else console.log("DELAYED call: supabaseClient is still not properly initialized.");
                                 showNotification("Gagal memuat fitur autentikasi setelah penundaan. Periksa konsol untuk detail.", true);
                                 disableAppFeatures();
                            }
                        }, 1500); // Penundaan 1.5 detik
                    }
                } catch (e) {
                    console.error("Exception during Supabase client initialization or mainAppLogic call:", e);
                    showNotification("Gagal menginisialisasi koneksi ke server. Coba lagi nanti.", true);
                    disableAppFeatures();
                }
            });

        </script>
    </body>
    </html>
    