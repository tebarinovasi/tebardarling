<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Petugas - TEBARDARLING</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Pustaka untuk kompresi gambar -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; /* slate-50 */
        }
        .leaflet-container { 
            height: 100%; 
            min-height: 300px;
            width: 100%; 
            border-radius: 0.75rem; /* rounded-xl */
            z-index: 1; 
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            -webkit-animation-name: fadeIn;
            animation-name: fadeIn;
            -webkit-animation-duration: 0.4s;
            animation-duration: 0.4s;
        }
        .modal-content {
            position: relative;
            background-color: #ffffff;
            margin: 10% auto;
            padding: 2rem;
            width: 90%;
            max-width: 450px;
            border-radius: 0.75rem;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            -webkit-animation-name: slideIn;
            animation-name: slideIn;
            -webkit-animation-duration: 0.5s;
            animation-duration: 0.5s;
        }
        @-webkit-keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @-webkit-keyframes slideIn { from {transform: translateY(-50px); opacity: 0} to {transform: translateY(0); opacity: 1} }
        @keyframes slideIn { from {transform: translateY(-50px); opacity: 0} to {transform: translateY(0); opacity: 1} }
        
        /* Custom file input */
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-input-label {
            border: 2px dashed #cbd5e1; /* slate-300 */
            border-radius: 0.75rem;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #f8fafc; /* slate-50 */
        }
        .file-input-label:hover {
            background-color: #f1f5f9; /* slate-100 */
            border-color: #94a3b8; /* slate-400 */
        }
        .file-input-label i {
            font-size: 1.75rem;
            color: #475569; /* slate-600 */
            margin-bottom: 0.75rem;
        }
        .file-input-label span {
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569; /* slate-600 */
        }
        #workPhoto {
            position: absolute;
            font-size: 100px;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="text-slate-700">

    <div class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <header class="mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800">Dashboard Petugas</h1>
                        <p class="text-slate-500 mt-1">Selamat Datang di Panel TEBARDARLING</p>
                    </div>
                    <div class="mt-4 sm:mt-0 text-left sm:text-right">
                        <p class="text-lg font-semibold text-sky-700" id="officerName">[Nama Petugas]</p>
                        <p class="text-xs text-slate-400">ID: <span id="displayUserId" class="font-mono bg-slate-200 px-1.5 py-0.5 rounded"></span></p>
                    </div>
                </div>
            </header>

            <!-- GPS Status Alert -->
            <div id="gpsStatus" class="mb-6 p-4 rounded-xl text-center text-white bg-amber-500 shadow-lg flex items-center justify-center space-x-3 transition-all duration-300">
                <i class="fas fa-satellite-dish fa-spin"></i> 
                <span class="font-medium">Menginisialisasi GPS... Pastikan GPS aktif dan berikan izin lokasi.</span>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <!-- Left Column: Attendance and Map -->
                <div class="lg:col-span-1 space-y-8">
                    <!-- Attendance Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-100 h-fit">
                        <div class="flex items-start justify-between">
                            <h2 class="text-xl font-bold text-slate-800 mb-2">Absensi</h2>
                             <span id="attendanceStatus" class="px-3 py-1 text-xs font-semibold rounded-full bg-slate-100 text-slate-600">Belum Absen</span>
                        </div>
                        <p class="text-sm text-slate-500 mb-4">Catat waktu masuk dan keluar Anda di sini.</p>
                        
                        <div class="bg-slate-50 p-4 rounded-xl mb-4 text-center">
                            <p class="text-sm text-slate-500">Waktu Kerja</p>
                            <p id="timer" class="text-4xl font-bold text-slate-800 tracking-tight">00:00:00</p>
                            <p id="clockInTimeDisplay" class="text-xs text-slate-400 mt-1 h-4"></p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button id="clockInButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2 shadow-sm hover:shadow-lg hover:-translate-y-0.5 disabled:bg-slate-300 disabled:shadow-none disabled:cursor-not-allowed disabled:transform-none">
                                <i class="fas fa-play"></i>
                                <span>Masuk</span>
                            </button>
                            <button id="clockOutButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2 shadow-sm hover:shadow-lg hover:-translate-y-0.5 disabled:bg-slate-300 disabled:shadow-none disabled:cursor-not-allowed disabled:transform-none">
                                <i class="fas fa-stop"></i>
                                <span>Keluar</span>
                            </button>
                        </div>
                    </div>

                    <!-- Map Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-100 flex flex-col">
                        <h2 class="text-xl font-bold text-slate-800 mb-2">Lokasi Anda</h2>
                        <p class="text-sm text-slate-500 mb-4">Peta menunjukkan lokasi Anda secara real-time.</p>
                        <div class="flex-grow h-full" id="map"></div>
                        <p class="text-xs text-slate-400 mt-3 text-center">Koordinat: <span id="coordinatesDisplay" class="font-mono">-</span></p>
                    </div>
                </div>

                <!-- Right Column: Documentation Upload -->
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md border border-slate-100">
                     <h2 class="text-xl font-bold text-slate-800 mb-2">Unggah Dokumentasi</h2>
                     <p class="text-sm text-slate-500 mb-6">Kirim foto dan deskripsi pekerjaan Anda setelah absen masuk.</p>
                    
                    <form id="uploadForm" class="space-y-5">
                        <!-- Custom File Input -->
                        <div>
                            <label for="workPhoto" class="block text-sm font-medium text-slate-600 mb-2">1. Pilih Foto Pekerjaan</label>
                            <div class="file-input-container">
                                <label for="workPhoto" class="file-input-label">
                                    <i class="fas fa-cloud-arrow-up"></i>
                                    <span id="file-chosen-text">Klik untuk memilih atau jatuhkan file di sini</span>
                                </label>
                                <input type="file" id="workPhoto" name="workPhoto" accept="image/*" disabled>
                            </div>
                        </div>

                        <!-- Photo Preview -->
                        <div id="photoPreviewContainer" class="mt-4 hidden bg-slate-50 rounded-xl p-3">
                            <img id="photoPreview" src="#" alt="Pratinjau Foto" class="max-h-60 w-auto mx-auto rounded-lg shadow-md"/>
                        </div>

                        <!-- Description Textarea -->
                        <div>
                             <label for="photoDescription" class="block text-sm font-medium text-slate-600 mb-2">2. Tambahkan Deskripsi</label>
                            <textarea id="photoDescription" placeholder="Jelaskan aktivitas atau temuan di lokasi..." rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition disabled:bg-slate-100" disabled></textarea>
                        </div>

                        <!-- Upload Button -->
                        <button id="uploadPhotoButton" type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-4 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-3 shadow-sm hover:shadow-lg hover:-translate-y-0.5 disabled:bg-slate-300 disabled:shadow-none disabled:cursor-not-allowed disabled:transform-none focus:outline-none focus:ring-4 focus:ring-sky-300">
                            <i class="fas fa-upload"></i>
                            <span>Unggah Dokumentasi</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Notifikasi -->
    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage" class="mb-6 text-lg font-medium text-slate-800"></p>
            <div id="modalButtons" class="flex justify-center space-x-3">
                <button id="modalOkButton" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2.5 px-8 rounded-lg transition-colors">OK</button>
                <button id="modalConfirmButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-6 rounded-lg hidden">Konfirmasi</button>
                <button id="modalCancelButton" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2.5 px-6 rounded-lg hidden">Batal</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        const SUPABASE_URL = 'https://zunrijrufbpldgfztroz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1bnJpanJ1ZmJwbGRnZnp0cm96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMjY4MzcsImV4cCI6MjA2NDYwMjgzN30.bUDiCIx-gM_nBUZWoU8N2311MlwQq7SOt1-fkyyWdbU';
        let supabaseClient;

        // --- DOM Elements ---
        const officerNameEl = document.getElementById('officerName');
        const displayUserIdEl = document.getElementById('displayUserId');
        const clockInButton = document.getElementById('clockInButton');
        const clockOutButton = document.getElementById('clockOutButton');
        const attendanceStatusEl = document.getElementById('attendanceStatus');
        const timerEl = document.getElementById('timer');
        const clockInTimeDisplayEl = document.getElementById('clockInTimeDisplay');
        const mapEl = document.getElementById('map');
        const coordinatesDisplayEl = document.getElementById('coordinatesDisplay');
        const uploadForm = document.getElementById('uploadForm');
        const workPhotoInput = document.getElementById('workPhoto');
        const photoPreview = document.getElementById('photoPreview');
        const photoPreviewContainer = document.getElementById('photoPreviewContainer');
        const photoDescriptionInput = document.getElementById('photoDescription');
        const uploadPhotoButton = document.getElementById('uploadPhotoButton');
        const gpsStatusEl = document.getElementById('gpsStatus');
        const notificationModal = document.getElementById('notificationModal');
        const modalMessageEl = document.getElementById('modalMessage');
        const modalOkButton = document.getElementById('modalOkButton');
        const modalConfirmButton = document.getElementById('modalConfirmButton');
        const modalCancelButton = document.getElementById('modalCancelButton');
        const fileChosenTextEl = document.getElementById('file-chosen-text');


        // --- App State ---
        let currentOfficer = null;
        let officerUserId = null;
        let officerFullName = null; 
        let map = null;
        let marker = null;
        let currentPosition = null;
        let isClockedIn = false;
        let clockInTime = null;
        let workTimerInterval = null;
        let locationWatchId = null;
        const MIN_WORK_HOURS = 8;
        let activeAttendanceId = null;
        let locationTrackingInterval = null; 
        const LOCATION_UPDATE_INTERVAL_MS = 5000; 
        let compressedFile = null; // Variabel untuk menyimpan file terkompresi

        // --- Main Logic ---
        async function mainAppLogic() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session?.user) {
                await handleUserSignIn(session.user);
            } else {
                showNotification("Sesi tidak ditemukan. Silakan login terlebih dahulu.", true);
                disableAppFeatures(true);
                updateGpsStatus('error', '<i class="fas fa-exclamation-triangle mr-2"></i> Anda harus login untuk menggunakan dashboard.');
            }

            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session?.user) {
                    await handleUserSignIn(session.user);
                } else if (event === 'SIGNED_OUT') {
                    currentOfficer = null;
                    officerUserId = null;
                    officerFullName = null; 
                    activeAttendanceId = null;
                    showNotification("Anda telah keluar. Silakan masuk kembali.", true);
                    disableAppFeatures(true);
                }
            });
        }

        async function handleUserSignIn(user) {
            currentOfficer = user;
            officerUserId = currentOfficer.id;
            
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('full_name')
                    .eq('id', officerUserId)
                    .single();

                if (error) throw error;
                
                if (profile && profile.full_name) {
                    officerFullName = profile.full_name;
                    officerNameEl.textContent = officerFullName;
                } else {
                    officerFullName = user.email || officerUserId;
                    officerNameEl.textContent = officerFullName;
                }
            } catch (error) {
                console.error("Gagal mengambil profil pengguna:", error.message);
                officerFullName = user.email || officerUserId;
                officerNameEl.textContent = officerFullName;
            }

            displayUserIdEl.textContent = officerUserId;
            await checkExistingAttendance();
            initApp();
        }

        function initApp() {
            if (!officerUserId) {
                console.error("User tidak terautentikasi. Fitur tetap nonaktif.");
                disableAppFeatures();
                return;
            }
            initMap();
            startGpsTracking();
            clockInButton.onclick = handleClockIn;
            clockOutButton.onclick = handleClockOutAttempt;
            workPhotoInput.onchange = handlePhotoSelectionAndCompression; // Mengganti fungsi handler
            uploadForm.onsubmit = handleUploadPhoto;
            modalOkButton.onclick = () => closeModal();

            if (isClockedIn) {
                updateUIForClockedIn();
            } else {
                updateUIForClockedOut();
            }
        }
        
        function disableAppFeatures(isLoggedOut = false) {
            clockInButton.disabled = true;
            clockOutButton.disabled = true;
            workPhotoInput.disabled = true;
            photoDescriptionInput.disabled = true;
            uploadPhotoButton.disabled = true;
            attendanceStatusEl.textContent = isLoggedOut ? "Tidak Login" : "Tidak Aktif";
            attendanceStatusEl.className = "px-3 py-1 text-xs font-semibold rounded-full bg-slate-100 text-slate-600";
            timerEl.textContent = "00:00:00";
            if (workTimerInterval) clearInterval(workTimerInterval);
            stopLocationTracking(); 
            isClockedIn = false;
        }

        async function checkExistingAttendance() {
            if (!officerUserId) return;
            try {
                const { data, error } = await supabaseClient.from('attendance').select('*').eq('officer_id', officerUserId).is('clock_out_time', null).order('clock_in_time', { ascending: false }).limit(1);
                if (error) throw error;
                if (data && data.length > 0) {
                    const lastAttendance = data[0];
                    activeAttendanceId = lastAttendance.id;
                    isClockedIn = true;
                    clockInTime = new Date(lastAttendance.clock_in_time);
                    startWorkTimer();
                    startLocationTracking();
                    showNotification("Melanjutkan sesi absensi sebelumnya.", false, 2000);
                } else {
                    isClockedIn = false;
                }
            } catch (error) {
                console.error('Error memeriksa absensi:', error);
                showNotification('Gagal memeriksa status absensi sebelumnya.', true);
            }
        }

        function initMap() {
            if (map) return;
            const defaultLocation = [3.5952, 98.6722];
            map = L.map(mapEl, { zoomControl: false }).setView(defaultLocation, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'TEBARDARLING' }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            marker = L.marker(defaultLocation).addTo(map).bindPopup("Mencari lokasi...").openPopup();
        }

        function updateGpsStatus(type, message) {
            gpsStatusEl.innerHTML = message;
            gpsStatusEl.classList.remove('bg-amber-500', 'bg-green-600', 'bg-red-600');
            switch (type) {
                case 'success':
                    gpsStatusEl.classList.add('bg-green-600');
                    break;
                case 'error':
                    gpsStatusEl.classList.add('bg-red-600');
                    break;
                case 'loading':
                default:
                    gpsStatusEl.classList.add('bg-amber-500');
                    break;
            }
        }

        function startGpsTracking() {
            if (locationWatchId) navigator.geolocation.clearWatch(locationWatchId);
            if (!navigator.geolocation) {
                updateGpsStatus('error', "Browser Anda tidak mendukung Geolocation.");
                disableAppFeatures();
                return;
            }
            locationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    currentPosition = { latitude: position.coords.latitude, longitude: position.coords.longitude, accuracy: position.coords.accuracy };
                    updateGpsStatus('success', `<i class="fas fa-check-circle mr-2"></i> GPS Aktif. Akurasi: ${currentPosition.accuracy.toFixed(0)} meter.`);
                    const latLng = [currentPosition.latitude, currentPosition.longitude];
                    if (map && marker) {
                       map.setView(latLng, 16);
                       marker.setLatLng(latLng).setPopupContent(`Lokasi Anda Saat Ini`).openPopup();
                    }
                    coordinatesDisplayEl.textContent = `${currentPosition.latitude.toFixed(5)}, ${currentPosition.longitude.toFixed(5)}`;
                },
                (error) => {
                    console.error("GPS Error:", error);
                    let errorMsg;
                    switch(error.code) {
                        case error.PERMISSION_DENIED: errorMsg = "Izin lokasi ditolak. Fitur peta dan absensi tidak akan berfungsi."; disableAppFeatures(); break;
                        case error.POSITION_UNAVAILABLE: errorMsg = "Informasi lokasi tidak tersedia saat ini."; break;
                        case error.TIMEOUT: errorMsg = "Waktu permintaan lokasi habis."; break;
                        default: errorMsg = "Gagal mendapatkan lokasi GPS."; break;
                    }
                    updateGpsStatus('error', `<i class="fas fa-exclamation-triangle mr-2"></i> ${errorMsg}`);
                    coordinatesDisplayEl.textContent = 'Tidak tersedia / Error';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function startLocationTracking() {
            stopLocationTracking(); 
            if (!isClockedIn) return; 
            console.log(`Memulai pelacakan lokasi setiap ${LOCATION_UPDATE_INTERVAL_MS / 1000} detik.`);
            locationTrackingInterval = setInterval(sendLocationUpdate, LOCATION_UPDATE_INTERVAL_MS);
        }

        function stopLocationTracking() {
            if (locationTrackingInterval) {
                clearInterval(locationTrackingInterval);
                locationTrackingInterval = null;
                console.log("Pelacakan lokasi dihentikan.");
            }
        }
        
        async function sendLocationUpdate() {
            if (!isClockedIn || !currentPosition || !officerUserId || !activeAttendanceId) {
                console.warn("Lewati pengiriman lokasi: data tidak lengkap.", {isClockedIn, hasPosition: !!currentPosition, officerUserId, activeAttendanceId});
                return;
            }

            const locationData = {
                officer_id: officerUserId,
                attendance_id: activeAttendanceId,
                latitude: currentPosition.latitude,
                longitude: currentPosition.longitude,
                accuracy: currentPosition.accuracy,
                timestamp: new Date().toISOString()
            };

            try {
                const { error } = await supabaseClient.from('officer_locations').insert(locationData);
                if (error) throw error;
                console.log('Update lokasi berhasil dikirim:', locationData);
            } catch (error) {
                console.error('Gagal mengirim update lokasi:', error.message);
            }
        }
        
        async function handleClockIn() {
            if (!currentPosition) {
                showNotification("Lokasi GPS tidak ditemukan. Pastikan GPS aktif dan izin diberikan.", true);
                return;
            }
            if (isClockedIn) return;
            clockInButton.disabled = true;
            clockInButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Proses...';
            clockInTime = new Date();
            try {
                const { data, error } = await supabaseClient.from('attendance').insert([{ officer_id: officerUserId, clock_in_time: clockInTime.toISOString(), clock_in_latitude: currentPosition.latitude, clock_in_longitude: currentPosition.longitude, clock_in_accuracy: currentPosition.accuracy }]).select();
                if (error || !data) throw error;
                isClockedIn = true;
                activeAttendanceId = data[0].id;
                showNotification(`Berhasil absen masuk pada ${clockInTime.toLocaleTimeString()}`, false, 3000);
                updateUIForClockedIn();
                startWorkTimer();
                startLocationTracking();
            } catch (error) {
                console.error("Error saat absen masuk:", error);
                showNotification("Gagal melakukan absensi masuk. Coba lagi.", true);
                clockInButton.disabled = false;
            } finally {
                 clockInButton.innerHTML = '<i class="fas fa-play"></i> Masuk';
            }
        }

        function handleClockOutAttempt() {
            if (!isClockedIn || !clockInTime) return;
            const now = new Date();
            const timeDiffMs = now.getTime() - clockInTime.getTime();
            const hoursWorked = timeDiffMs / (1000 * 60 * 60);
            if (hoursWorked < MIN_WORK_HOURS) {
                const remainingTimeMs = (MIN_WORK_HOURS * 60 * 60 * 1000) - timeDiffMs;
                const remainingHours = Math.floor(remainingTimeMs / (1000 * 60 * 60));
                const remainingMinutes = Math.floor((remainingTimeMs % (1000 * 60 * 60)) / (1000 * 60));
                showModalConfirmation(`Anda belum bisa absen keluar. Jam kerja minimal ${MIN_WORK_HOURS} jam. Sisa waktu kerja Anda sekitar ${remainingHours} jam ${remainingMinutes} menit.`, null, true);
            } else {
                showModalConfirmation(`Konfirmasi absen keluar? Waktu kerja Anda: ${formatDuration(timeDiffMs)}.`, handleClockOutConfirm);
            }
        }

        async function handleClockOutConfirm() {
            if (!currentPosition) {
                showNotification("Lokasi GPS tidak ditemukan untuk absen keluar. Coba lagi.", true);
                closeModal();
                return;
            }
            if (!activeAttendanceId) return;
            closeModal();
            clockOutButton.disabled = true;
            clockOutButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Proses...';
            const clockOutTime = new Date();
            const timeDiffMs = clockOutTime.getTime() - clockInTime.getTime();
            try {
                await sendLocationUpdate(); 
                stopLocationTracking();
                
                const { data, error } = await supabaseClient.from('attendance').update({ clock_out_time: clockOutTime.toISOString(), clock_out_latitude: currentPosition.latitude, clock_out_longitude: currentPosition.longitude, clock_out_accuracy: currentPosition.accuracy, work_duration_ms: timeDiffMs }).eq('id', activeAttendanceId).select();
                if (error || !data) throw error;
                isClockedIn = false;
                activeAttendanceId = null;
                stopWorkTimer();
                showNotification(`Berhasil absen keluar. Total jam kerja: ${formatDuration(timeDiffMs)}.`, false, 4000);
                updateUIForClockedOut();
                clockInTimeDisplayEl.textContent = `Keluar: ${clockOutTime.toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}`;
                resetUploadForm();
            } catch(error) {
                console.error("Error saat absen keluar:", error);
                showNotification("Gagal melakukan absensi keluar. Coba lagi.", true);
                startLocationTracking();
            } finally {
                clockOutButton.disabled = !isClockedIn;
                clockOutButton.innerHTML = '<i class="fas fa-stop"></i> Keluar';
            }
        }
        
        // --- FUNGSI UNGGAH DENGAN TIMEOUT ---
        async function handleUploadPhoto(event) {
            event.preventDefault();
            if (!isClockedIn || !activeAttendanceId) {
                showNotification("Anda harus absen masuk untuk mengunggah dokumentasi.", true);
                return;
            }
            const fileToUpload = compressedFile; // Menggunakan file yang sudah dikompresi
            const description = photoDescriptionInput.value.trim();
            if (!fileToUpload || !description || !currentPosition) {
                showNotification("Harap pilih foto, isi deskripsi, dan pastikan GPS aktif.", true);
                return;
            }

            uploadPhotoButton.disabled = true;
            uploadPhotoButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengunggah...';

            try {
                const UPLOAD_TIMEOUT = 30000; // 30 detik timeout

                const uploadPromise = async () => {
                    const sanitizedOfficerName = officerFullName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                    // Menggunakan nama file asli untuk konsistensi, tapi dengan timestamp
                    const fileName = `${Date.now()}_${fileToUpload.name.replace(/\s+/g, '_')}`;
                    const filePath = `${sanitizedOfficerName}/${fileName}`;

                    const { data: uploadData, error: uploadError } = await supabaseClient.storage.from('photos').upload(filePath, fileToUpload);
                    if (uploadError) throw uploadError;

                    const { error: dbError } = await supabaseClient.from('work_documentation').insert([{ 
                        officer_id: officerUserId, 
                        attendance_id: activeAttendanceId, 
                        photo_path: uploadData.path, 
                        description: description, 
                        latitude: currentPosition.latitude, 
                        longitude: currentPosition.longitude, 
                        timestamp: new Date().toISOString() 
                    }]);
                    if (dbError) throw dbError;
                };

                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Waktu unggah habis (30 detik). Periksa koneksi internet Anda.')), UPLOAD_TIMEOUT)
                );

                await Promise.race([uploadPromise(), timeoutPromise]);

                showNotification("Foto dokumentasi berhasil diunggah!", false, 3000);
                resetUploadForm();

            } catch (error) {
                console.error("Error saat mengunggah foto:", error);
                showNotification(`Gagal mengunggah foto: ${error.message}`, true);
            } finally {
                uploadPhotoButton.disabled = !isClockedIn;
                uploadPhotoButton.innerHTML = '<i class="fas fa-upload"></i> Unggah Dokumentasi';
            }
        }
        
        // --- FUNGSI BARU: KOMPRESI & PREVIEW ---
        async function handlePhotoSelectionAndCompression(event) {
            const file = event.target.files[0];
            if (!file) {
                photoPreviewContainer.classList.add('hidden');
                fileChosenTextEl.textContent = "Klik untuk memilih atau jatuhkan file di sini";
                compressedFile = null;
                return;
            }

            fileChosenTextEl.textContent = `Memproses: ${file.name}...`;

            const options = {
                maxSizeMB: 1,          // Ukuran maksimal file 1MB
                maxWidthOrHeight: 1920, // Resolusi maksimal 1920px
                useWebWorker: true,    // Menggunakan web worker untuk performa lebih baik
                fileType: 'image/jpeg', // Mengonversi ke JPEG untuk ukuran lebih kecil
            }

            try {
                const originalSize = (file.size / 1024 / 1024).toFixed(2);
                console.log(`Ukuran asli: ${originalSize} MB`);

                // Menggunakan pustaka imageCompression yang sudah di-load di <head>
                const compressedImageFile = await imageCompression(file, options);
                
                const compressedSize = (compressedImageFile.size / 1024 / 1024).toFixed(2);
                console.log(`Ukuran setelah kompresi: ${compressedSize} MB`);
                showNotification(`Foto dikompres dari ${originalSize} MB menjadi ${compressedSize} MB.`, false, 3000);

                // Simpan file terkompresi ke variabel global
                compressedFile = new File([compressedImageFile], file.name, { type: 'image/jpeg', lastModified: Date.now() });

                // Tampilkan preview dari file terkompresi
                photoPreview.src = URL.createObjectURL(compressedFile);
                photoPreviewContainer.classList.remove('hidden');
                fileChosenTextEl.textContent = `Terpilih: ${file.name}`;

            } catch (error) {
                console.error('Error saat kompresi gambar:', error);
                showNotification(`Gagal memproses gambar: ${error.message}`, true);
                fileChosenTextEl.textContent = "Gagal memproses, coba lagi.";
                compressedFile = null;
                workPhotoInput.value = ""; // Reset input file
            }
        }

        function updateUIForClockedIn() {
            attendanceStatusEl.textContent = "Aktif Bekerja";
            attendanceStatusEl.className = "px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700";
            clockInButton.disabled = true;
            clockOutButton.disabled = false;
            workPhotoInput.disabled = false;
            photoDescriptionInput.disabled = false;
            uploadPhotoButton.disabled = false;
            if (clockInTime) {
                clockInTimeDisplayEl.textContent = `Masuk: ${clockInTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute:'2-digit' })}`;
            }
        }

        function updateUIForClockedOut() {
            attendanceStatusEl.textContent = "Sudah Keluar";
            attendanceStatusEl.className = "px-3 py-1 text-xs font-semibold rounded-full bg-slate-100 text-slate-600";
            clockInButton.disabled = false;
            clockOutButton.disabled = true;
            workPhotoInput.disabled = true;
            photoDescriptionInput.disabled = true;
            uploadPhotoButton.disabled = true;
            timerEl.textContent = "00:00:00";
            clockInTimeDisplayEl.textContent = "";
        }

        function resetUploadForm() {
            uploadForm.reset();
            photoPreviewContainer.classList.add('hidden');
            photoPreview.src = "#";
            fileChosenTextEl.textContent = "Klik untuk memilih atau jatuhkan file di sini";
            compressedFile = null; // Reset variabel file terkompresi
        }
        
        function startWorkTimer() {
            if (workTimerInterval) clearInterval(workTimerInterval);
            workTimerInterval = setInterval(() => {
                if (isClockedIn && clockInTime) {
                    const timeDiffMs = new Date().getTime() - clockInTime.getTime();
                    timerEl.textContent = formatDuration(timeDiffMs);
                }
            }, 1000);
        }

        function stopWorkTimer() {
            clearInterval(workTimerInterval);
            workTimerInterval = null;
        }

        function formatDuration(ms) {
            let totalSeconds = Math.floor(ms / 1000);
            let hours = Math.floor(totalSeconds / 3600);
            let minutes = Math.floor((totalSeconds % 3600) / 60);
            let seconds = totalSeconds % 60;
            return [hours, minutes, seconds].map(v => v < 10 ? "0" + v : v).join(":");
        }


        function showNotification(message, isError = false, duration = null) {
            modalMessageEl.textContent = message;
            modalMessageEl.className = isError ? 'mb-6 text-lg font-medium text-red-600' : 'mb-6 text-lg font-medium text-slate-800';
            modalOkButton.style.display = 'inline-block';
            modalConfirmButton.style.display = 'none';
            modalCancelButton.style.display = 'none';
            notificationModal.style.display = "block";
            if (duration) setTimeout(() => { if (notificationModal.style.display === "block") closeModal(); }, duration);
        }

        function showModalConfirmation(message, confirmAction, isInfoOnly = false) {
            modalMessageEl.textContent = message;
            modalMessageEl.className = 'mb-6 text-lg font-medium text-slate-800';
            modalOkButton.style.display = isInfoOnly ? 'inline-block' : 'none';
            modalConfirmButton.style.display = isInfoOnly ? 'none' : 'inline-block';
            modalCancelButton.style.display = isInfoOnly ? 'none' : 'inline-block';
            
            const newConfirmButton = modalConfirmButton.cloneNode(true);
            modalConfirmButton.parentNode.replaceChild(newConfirmButton, modalConfirmButton);
            
            if (confirmAction) {
                newConfirmButton.addEventListener('click', function onConfirm() {
                    confirmAction();
                    closeModal();
                    newConfirmButton.removeEventListener('click', onConfirm);
                });
            }

            const newCancelButton = modalCancelButton.cloneNode(true);

            modalCancelButton.parentNode.replaceChild(newCancelButton, modalCancelButton);
            newCancelButton.addEventListener('click', function onCancel() {
                closeModal();
                newCancelButton.removeEventListener('click', onCancel);
            });

            window.modalConfirmButton = newConfirmButton;
            window.modalCancelButton = newCancelButton;

            notificationModal.style.display = "block";
        }


        function closeModal() {
            notificationModal.style.display = "none";
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Klien Supabase berhasil diinisialisasi.");
                mainAppLogic();
            } catch (e) {
                console.error("FATAL: Gagal menginisialisasi Klien Supabase.", e);
                showNotification("Gagal memuat aplikasi. Periksa koneksi dan coba muat ulang halaman.", true);
                disableAppFeatures(true);
            }
        });
    </script>
</body>
</html>
